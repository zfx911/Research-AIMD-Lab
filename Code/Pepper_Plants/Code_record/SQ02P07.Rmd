---
title: "P07"
author: "zifengxu"
date: "2024-03-09"
output: html_document
---

# Read the Data (PSI)
```{r}
library(haven)
library(dplyr)
library(stringr)
library(tidyr)
library(jsonlite)
```

```{r}
#df <- read_sav("../data/grade9/BSLNORZ7_PSI.sav")

# Explore the data
head(df)
```

Remove the rows of auto check for this question. 
```{r}
df_filter <- df %>%
  filter(df$PSIVariableIdentifier != 8048 |is.na(df$PSIVariableIdentifier))
```


Filter the rows and exactly one row above the row that satisfied one of the conditions below: 

Condition 1: BlockName=SQ01, BookletPart=1, BlockInPart=1, currentindex=6.

Condition 2: BlockName=SQ01, BookletPart=2, BlockInPart=2, currentindex=21.

```{r}
condition1 <- df_filter$BlockName == 'SQ02' & 
              df_filter$BookletPart == 1 & 
              df_filter$BlockInPart == 1 & 
              df_filter$currentindex == 6 

# Define the second condition
condition2 <- df_filter$BlockName == 'SQ02' & 
              df_filter$BookletPart == 2 & 
              df_filter$BlockInPart == 2 & 
              df_filter$currentindex == 21 

# Combine the two conditions using OR (|) as you want rows satisfying either condition
combined_condition <- condition1 | condition2

# Use filter to get the rows that satisfy the conditions and one row below
result7 <- df_filter %>% 
  filter(combined_condition | lag(combined_condition, default = FALSE))

result7
```


### Module Path
Create a new column module_path based on (BlockName, BookletPart, BlockInPart, currentindex)
```{r}
result_use_Q7= transform(result7,
                       module_path = paste0("(", BlockName, ", ", BookletPart, ", ", BlockInPart, ")"))
head(result_use_Q7)
```

```{r}
unique(result_use_Q7$eventname)
```


### Time
```{r}
result_filter_Q7=result_use_Q7 %>%filter(eventname %in% c("Nav:GoTo", "Response", "UI:Scrollbar", "Btn:Calc"))
result_filter_Q7
```

```{r}
result_time_complete_Q7=result_filter_Q7 %>%
  mutate(SQ02P07_time = ifelse(currentindex == 21 & eventname == 'Nav:GoTo' | currentindex == 6 & eventname == 'Nav:GoTo', 0, ifelse(timemilisec - lag(timemilisec) > 0,
                                      (timeunixsec - lag(timeunixsec) + (timemilisec - lag(timemilisec))/1000),
                                      (timeunixsec - lag(timeunixsec) - 1 + (timemilisec + 1000 - lag(timemilisec))/1000))))
# head(result_time_complete_Q7[c("idstud","module_path","SQ02P07_time")])

# result_time_complete_Q7
```

```{r}
result_time_complete_Q7 = result_time_complete_Q7%>%
  mutate(RowNumber = row_number())
```

```{r}
result_time_complete_Q7$SQ02P07_unit_time <- result_time_complete_Q7$timeunixsec * 1000 + result_time_complete_Q7$timemilisec

# show all the units
result_time_complete_Q7$SQ02P07_unit_time <- format(result_time_complete_Q7$SQ02P07_unit_time, scientific = FALSE)
```

```{r}
result_time_complete_Q7
```


### Change the choice pair
If the column PSIVariableIdentifier == 8035, and the column information is not empty, then fill in "Click_Tank1" to information.
If the column PSIVariableIdentifier == 8036, and the column information is not empty, then fill in "Tank1_A_" + information to information.
If the column PSIVariableIdentifier == 8037, and the column information is not empty, then fill in "Tank1_B_" to information.
If the column PSIVariableIdentifier == 8038, and the column information is not empty, then fill in "Tank1_T_" + information to information.
If the column PSIVariableIdentifier == 8039, and the column information is not empty, then fill in "Click_Tank2" to information.
If the column PSIVariableIdentifier == 8040, and the column information is not empty, then fill in "Tank2_A_" + information to information.
If the column PSIVariableIdentifier == 8041, and the column information is not empty, then fill in "Tank2_B_" to information.
If the column PSIVariableIdentifier == 8042, and the column information is not empty, then fill in "Tank2_T_" + information to information.
If the column PSIVariableIdentifier == 8043, and the column information is not empty, then fill in "Click_Tank3" to information.
If the column PSIVariableIdentifier == 8044, and the column information is not empty, then fill in "Tank3_A_" + information to information.
If the column PSIVariableIdentifier == 8045, and the column information is not empty, then fill in "Tank3_B_" to information.
If the column PSIVariableIdentifier == 8046, and the column information is not empty, then fill in "Tank3_T_" + information to information.

```{r}
result_all_actions_Q7 <- result_time_complete_Q7 %>%
  mutate(information = case_when(
    PSIVariableIdentifier == 8035 & information != "" ~ "Click_Tank1",
    PSIVariableIdentifier == 8036 & information != "" ~ paste0("Tank1_A_", information),
    PSIVariableIdentifier == 8037 & information != "" ~ paste0("Tank1_B_", information),
    PSIVariableIdentifier == 8038 & information != "" ~ paste0("Tank1_T_", information),
    PSIVariableIdentifier == 8039 & information != "" ~ "Click_Tank2",
    PSIVariableIdentifier == 8040 & information != "" ~ paste0("Tank2_A_", information),
    PSIVariableIdentifier == 8041 & information != "" ~ paste0("Tank2_B_", information),
    PSIVariableIdentifier == 8042 & information != "" ~ paste0("Tank2_T_", information),
    PSIVariableIdentifier == 8043 & information != "" ~ "Click_Tank3",
    PSIVariableIdentifier == 8044 & information != "" ~ paste0("Tank3_A_", information),
    PSIVariableIdentifier == 8045 & information != "" ~ paste0("Tank3_B_", information),
    PSIVariableIdentifier == 8046 & information != "" ~ paste0("Tank3_T_", information),
    TRUE ~ information
  ))

result_all_actions_Q7
```


### 思路1
8035,8039,8043
8036,8037,8038,8040,8041,8042,8044,8045,8046

包含从PSI=8035,8039,8043直到navigate

filter the dataframe 
groupby idstud, filter the dataframe that only contain the rows between the row of the column PSIVariableIdentifier == 8035 or 8039 or 8043 until the row of the column eventname == "Nav:GoTo".


```{r}
result_all_actions_Q7%>%
  group_by(idstud) %>%
  filter(row_number() >= which(PSIVariableIdentifier %in% c(8035, 8039, 8043))[1])%>%
  filter(eventname %in% c("Nav:GoTo", "Response"))%>%
  select(idstud,currentindex,eventname,information,IsFinalAnswer,PSIVariableIdentifier, RowNumber)
```

```{r}
df_check2
#%>%filter(idstud == 50110523)
```


```{r}
result_all_actions_Q7%>%
  group_by(idstud) %>%
  filter(
    cumsum(PSIVariableIdentifier %in% c(8035, 8039, 8043)) > 0 &
    cumsum(eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21))) == 0
  )%>%
  filter(eventname %in% c("Nav:GoTo", "Response"))%>%
  select(idstud,currentindex,eventname,information,IsFinalAnswer,PSIVariableIdentifier,RowNumber)
```

```{r}
result_all_actions_Q7%>%
  group_by(idstud)%>%
   mutate(
    condition_start = ifelse(PSIVariableIdentifier %in% c(8035, 8039, 8043), 1, 0),
    condition_end = ifelse((eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21))), 1, 0),
    condition_group = cumsum(condition_start) - cumsum(condition_end)
  ) %>%
  filter(
    condition_group == 1 | condition_start == 1
  ) %>%
  filter(eventname %in% c("Nav:GoTo", "Response"))%>%
  select(idstud,currentindex,eventname,information,IsFinalAnswer,PSIVariableIdentifier,RowNumber)
```

I want the condition_end satisfied these 2 conditions:
(1) eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21))
(2) PSIVariableIdentifier %in% c(8035, 8039, 8043)
If the condition_end is (2), the new condition_start will be exactly same row of the condition_end

group by the idstud based on df1, then 

```{r}
# - Using 'cumsum' to keep track of cumulative occurrences of PSIVariableIdentifier and the condition (eventname == "Nav:GoTo" & currentindex not equal to 6 or 21).

# - For the PSIVariableIdentifier condition, it checks if the cumulative sum is greater than 0, indicating at least one occurrence of 8035, 8039, or 8043.

# - For the eventname condition, it checks if the cumulative sum is 0, indicating that the condition hasn't been met yet.

# ungroup the dataframe if you no longer need grouping
# ungroup(filtered_df)
```


```{r}
length(unique(result_all_actions_Q7[result_all_actions_Q7$PSIVariableIdentifier %in% c(8035, 8039, 8043),]$idstud))
```

```{r}
df_check2=result_all_actions_Q7%>%
  group_by(idstud)%>%
   mutate(
    condition_start = ifelse(PSIVariableIdentifier %in% c(8035, 8039, 8043), 1, 0),
    condition_end = ifelse(eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)), 1, 0),
    condition_group = cumsum(condition_start) - cumsum(condition_end)
  ) %>%
  mutate(
    condition_group = ifelse(condition_end == 1, 0, condition_group)) %>%
  filter(
    condition_group >= 1 | condition_start == 1
  ) %>%
  filter(eventname %in% c("Nav:GoTo", "Response"))%>%
  select(idstud,currentindex,eventname,information,IsFinalAnswer,PSIVariableIdentifier,RowNumber,condition_start, condition_end, condition_group)
df_check2
```

50110523

```{r}
result_all_actions_Q7%>%
  group_by(idstud)%>%
   mutate(
    condition_start = ifelse(PSIVariableIdentifier %in% c(8035, 8039, 8043), 1, 0),
    condition_end = ifelse(eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)), 1, 0),
    condition_group = cumsum(condition_start) - cumsum(condition_end)
  ) %>%
  filter(
    condition_group >= 1 | condition_start == 1
  ) %>%
  filter(eventname %in% c("Nav:GoTo", "Response"))%>%  select(idstud,currentindex,eventname,information,IsFinalAnswer,PSIVariableIdentifier,RowNumber,condition_start, condition_end, condition_group)
```

based on the code above, I want to change the condition_group as if condition_end == 1, then it return 0, otherwise, return cumsum(condition_start) - cumsum(condition_end)
```{r}
result_all_actions_Q7%>%
  group_by(idstud)%>%
   mutate(
    condition_start = ifelse(PSIVariableIdentifier %in% c(8035, 8039, 8043), 1, 0),
    condition_end = ifelse(eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)), 1, 0),
    condition_group = ifelse(condition_end == 1, 0, cumsum(condition_start))
  ) %>%
 select(idstud,currentindex,eventname,information,IsFinalAnswer,PSIVariableIdentifier,RowNumber,condition_start, condition_end, condition_group)

```
based on the code above, I want to change the condition of condition_group as if condition_end ==1, the value of the condition_group of this row and all the rows after this row until the next condition_start appears is 0, otherwise, return cumsum(condition_start).


the condition_group == 0 for the rows satisfied the condition that condition_end == 1 and all the rows after the condition_end == 1, until the next condition_start above appears.


```{r}
result_all_actions_Q7 %>%
  group_by(idstud) %>%
  mutate(
    condition_start = ifelse(PSIVariableIdentifier %in% c(8035, 8039, 8043), 1, 0),
    condition_end = ifelse(eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)), 1, 0),
    condition_group = ifelse(condition_end == 1, 0, cumsum(condition_start)) - cumsum(condition_end)
  ) %>%
  filter(
    condition_group >= 1 | condition_start == 1
  ) %>%
  filter(eventname %in% c("Nav:GoTo", "Response")) %>%
  select(idstud, currentindex, eventname, information, IsFinalAnswer, PSIVariableIdentifier, RowNumber, condition_start, condition_end, condition_group)

```


I want to add a condition that if the condition_end ==1, then change the condition group == 0.

```{r}
anti_join(df_check1, df_check2, by = "idstud")
```


```{r}
# 50110523
df_check1%>%
  filter(idstud==50110523)
```

### 思路2
```{r}
result_all_actions_Q7 %>%
  group_by(idstud) %>%
  mutate(
    condition_start = ifelse(PSIVariableIdentifier %in% c(8035, 8039, 8043), 1, 0),
    condition_end = ifelse(eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)), 1, 0),
    condition_group = ifelse(condition_end == 1, 0, cumsum(condition_start)) - cumsum(condition_end)
  ) %>%
  filter(
    condition_group >= 1 | condition_start == 1
  ) %>%
  filter(eventname %in% c("Nav:GoTo", "Response")) %>%
  select(idstud, currentindex, eventname, information, IsFinalAnswer, PSIVariableIdentifier, RowNumber, condition_start, condition_end, condition_group)

```

groupby idstud, create a new column cond_temp that if PSIVariableIdentifier %in% c(8035, 8039, 8043) then the value of the column == 1, if eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)), then the value of the column ==2, else, 0.

Create a new column cond_res based on If the value of the column cond_temp == 1, then cond_res return 1, and the value of the column cond_res == 1 for all the rows after this row until the column cond_temp == 2. Otherwise, the value of the column cond_res == 0.

the value of the column cond_res == 1 all the row after this row 
```{r}
result_all_actions_Q7%>%
  group_by(idstud) %>%
  mutate(
    cond_temp = case_when(
      PSIVariableIdentifier %in% c(8035, 8039, 8043) ~ 1,
      eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)) ~ 2,
      TRUE ~ 0
    )
  )%>%
  select(idstud, currentindex, eventname, information, cond_temp)
```

```{r}
df_temp$cond_res <- 0

# Loop through rows
for (i in 1:nrow(df_temp)) {
  # If cond_temp is 1, set cond_res to 1 and update subsequent rows until cond_temp becomes 2
  if (df_temp$cond_temp[i] == 1) {
    df_temp$cond_res[i] <- 1
    j <- i + 1
    while (j <= nrow(df_temp) && df_temp$cond_temp[j] != 2) {
      df_temp$cond_res[j] <- 1
      j <- j + 1
    }
  }
}

df_temp%>%
  select(idstud, currentindex, eventname, information, cond_temp, cond_res)
```

```{r}
df_temp%>%
filter(eventname %in% c("Nav:GoTo", "Response"))%>%
  filter(cond_res == 1) %>%
  select(idstud, currentindex, eventname, information, cond_temp, cond_res)
```

正常的nav的currid以及Nav去哪了的那些可以return一个其他任何数字，UI:Scrollbar也包括
If eventname == "Nav:GoTo" | eventname == "UI:Scrollbar", then cond_res == 6 
```{r}
df_temp2=df_temp%>%
  mutate(cond_res = ifelse(eventname == "Nav:GoTo" | eventname == "UI:Scrollbar", 6, cond_res))
df_temp2
```

```{r}
df_temp2%>%
#filter(eventname %in% c("Nav:GoTo", "Response"))%>%
  # filter(cond_res == 1) %>%
  filter(cond_res == 1 | cond_res == 6) %>%
  select(idstud, currentindex, eventname, information, cond_temp, cond_res)
```

当作这个道题时，用1，all steps用1和6

### Change in sequence
Create a new dataframe df_temp: groupby idstud, create a new column cond_temp that if PSIVariableIdentifier %in% c(8035, 8039, 8043) then the value of the column == 1, if eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)), then the value of the column ==2, else, 0.
```{r}
df_temp = result_all_actions_Q7%>%
  group_by(idstud) %>%
  mutate(
    cond_temp = case_when(
      PSIVariableIdentifier %in% c(8035, 8039, 8043) ~ 1,
      eventname == "Nav:GoTo" & !(currentindex %in% c(6, 21)) ~ 2,
      TRUE ~ 0
    )
  )
#%>%select(idstud, currentindex, eventname, information, cond_temp)
```

```{r}
df_temp$cond_res <- 0

# Loop through rows
for (i in 1:nrow(df_temp)) {
  # If cond_temp is 1, set cond_res to 1 and update subsequent rows until cond_temp becomes 2
  if (df_temp$cond_temp[i] == 1) {
    df_temp$cond_res[i] <- 1
    j <- i + 1
    while (j <= nrow(df_temp) && df_temp$cond_temp[j] != 2) {
      df_temp$cond_res[j] <- 1
      j <- j + 1
    }
  }
}

df_temp%>%
  select(idstud, currentindex, eventname, information, cond_temp, cond_res)
```

```{r}
df_check1 = df_temp%>%
filter(eventname %in% c("Nav:GoTo", "Response"))%>%
  filter(cond_res == 1) %>%
  select(idstud, currentindex, eventname, information, cond_temp, cond_res)
df_check1
```

```{r}
df_filtered <- df_temp%>%
filter(eventname %in% c("Nav:GoTo", "Response"))%>%
  filter(cond_res == 1) %>%
  filter(PSIVariableIdentifier %in% c(8036,8037,8038,8040,8041,8042,8044,8045,8046))%>%
  mutate(SQ02P07_sequence_list = list(information[order(row_number())]))

# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02P07_revise_sequence <- sapply(df_filtered$SQ02P07_sequence_list, function(x) paste0("(", toString(x), ")"))

df_filtered%>%
  select(idstud, currentindex, eventname, information, cond_temp, cond_res, SQ02P07_revise_sequence)
```

Create a new dataframe by merge the two dataframes by using the column idstud, and RowNumber.
```{r}
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02P07_revise_sequence")]
```

```{r}
result_choice_seq_Q7 <- merge(result_all_actions_Q7, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
# result_choice_seq_Q7
```

Then fill in all the missing value of the column SQ02P07_revise_sequence according to the student name.
```{r}
result_choice_seq_Q7=result_choice_seq_Q7%>%
  group_by(idstud) %>%
  fill(SQ02P07_revise_sequence, .direction = "downup")
result_choice_seq_Q7
```


### Final Choice in sequence
Filter the dataframe that only remain those columns: idstud, PSIVariableIdentifier, IsFinalAnswer, information, RowNumber.
```{r}
filtered_col = result_all_actions_Q7%>%
  select(idstud, PSIVariableIdentifier, IsFinalAnswer, information, RowNumber)
filtered_col
```

Create a new column SQ02P07_final_answer. Group by idstud, filter the data by using PSIVariableIdentifier == 8036,8037,8038,8040,8041,8042,8044,8045,8046 and IsfinalAnswer == 1. For each idstud, 
If PSIVariableIdentifier == 8036 and information == "", then change the information == "Tank1_A_NA", 
If PSIVariableIdentifier == 8037 and information == "", then change the information == "Tank1_B_NA",
If PSIVariableIdentifier == 8038 and information == "", then change the information == "Tank1_T_NA",
If PSIVariableIdentifier == 8040 and information == "", then change the information == "Tank2_A_NA",
If PSIVariableIdentifier == 8041 and information == "", then change the information == "Tank2_B_NA",
If PSIVariableIdentifier == 8042 and information == "", then change the information == "Tank2_T_NA",
If PSIVariableIdentifier == 8044 and information == "", then change the information == "Tank3_A_NA",
If PSIVariableIdentifier == 8045 and information == "", then change the information == "Tank3_B_NA",
If PSIVariableIdentifier == 8046 and information == "", then change the information == "Tank3_T_NA",

Then create a new column SQ02P07_sequence_list which is a list of information group by idstud order by PSIVariableIdentifier
```{r}
filtered_col %>%
  filter(PSIVariableIdentifier %in% c(8036,8037,8038,8040,8041,8042,8044,8045,8046)) %>%
  filter(IsFinalAnswer == 1) %>%
  group_by(idstud)
```

```{r}
df_filtered=filtered_col %>%
  filter(PSIVariableIdentifier %in% c(8036,8037,8038,8040,8041,8042,8044,8045,8046)) %>%
  filter(IsFinalAnswer == 1) %>%
  group_by(idstud) %>%
  complete(PSIVariableIdentifier = c(8036,8037,8038,8040,8041,8042,8044,8045,8046), fill = list(IsFinalAnswer = 1, RowNumber = -1)) %>%
  mutate(information = case_when(
    PSIVariableIdentifier == 8036 & information == "" ~ "Tank1_A_NA",
    PSIVariableIdentifier == 8037 & information == "" ~ "Tank1_B_NA",
    PSIVariableIdentifier == 8038 & information == "" ~ "Tank1_T_NA",
    PSIVariableIdentifier == 8040 & information == "" ~ "Tank2_A_NA",
    PSIVariableIdentifier == 8041 & information == "" ~ "Tank2_B_NA",
    PSIVariableIdentifier == 8042 & information == "" ~ "Tank2_T_NA",
    PSIVariableIdentifier == 8044 & information == "" ~ "Tank3_A_NA",
    PSIVariableIdentifier == 8045 & information == "" ~ "Tank3_B_NA",
    PSIVariableIdentifier == 8046 & information == "" ~ "Tank3_T_NA",
    TRUE ~ information
  )) %>%
  ungroup() %>%
  arrange(idstud, PSIVariableIdentifier) %>%
  group_by(idstud) %>%
  summarize(SQ02P07_sequence_list = list(information)) %>%
  ungroup()

df_filtered$SQ02P07_final_answer <- sapply(df_filtered$SQ02P07_sequence_list, function(x) paste0("(", toString(x), ")"))

df_filtered
```

Create a new dataframe by merge the two dataframes by using the column idstud.
```{r}
df_filtered_merge = df_filtered[c("idstud","SQ02P07_final_answer")]
```

```{r}
result_Final_choice_Q7 <- merge(result_choice_seq_Q7, df_filtered_merge, by = c("idstud"), all = TRUE)
result_Final_choice_Q7
```


### All Steps
Create a new dataframe df_temp2 based on df_temp which is created in SQ02P07_revise_sequence. If eventname == "Nav:GoTo" | eventname == "UI:Scrollbar", then cond_res == 6 
```{r}
df_temp2=df_temp%>%
  mutate(cond_res = ifelse(eventname == "Nav:GoTo" | eventname == "UI:Scrollbar", 6, cond_res))
df_temp2
```

filter df_temp2 with cond_res == 1 or cond_res == 6.
```{r}
result_copy_Q7 = df_temp2%>%
  filter(cond_res == 1 | cond_res == 6)
result_copy_Q7
```

Create a new dataframe by copy the original one.Create a new column step_str based on the other column.
If PSIVariableIdentifier == 8035,8036,8037,8038,8039,8040,8041,8042,8043,8044,8045,8046, then step_str == information
If eventname == "Nav:GoTo" & new_currentindex == 6, then step_str == "Begin_Q7"
If eventname == "Nav:GoTo" & new_currentindex != 6, then step_str == "Nevigate_to_Q"+ value of the column new_currentindex
If eventname == "UI:Scrollbar", step_str == extract the value after event and scrollTop in the column information.
If eventname == "Btn:Calc", step_str == "Calculator" + extract the value after To in the column information.

Create a column new_currentindex by changing the column currentindex based on the rule below:
15 to 0, 16 to 1, 17 to 2, 18 to 3, 19 to 4, 20 to 56, 21 to 6, 22 to 7, 23 to 8, 24 to 9, 25 to 10, 26 to 11, 27 to 12, 28 to 13
```{r}
result_copy_Q7 <- result_copy_Q7 %>%
  mutate(new_currentindex = case_when(
    currentindex == 15 ~ 0,
    currentindex == 16 ~ 1,
    currentindex == 17 ~ 2,
    currentindex == 18 ~ 3,
    currentindex == 19 ~ 4,
    currentindex == 20 ~ 5,
    currentindex == 21 ~ 6,
    currentindex == 22 ~ 7,
    currentindex == 23 ~ 8,
    currentindex == 24 ~ 9,
    currentindex == 25 ~ 10,
    currentindex == 26 ~ 11,
    currentindex == 27 ~ 12,
    currentindex == 28 ~ 13,
    TRUE ~ currentindex  # Keep the original value if it doesn't match any rule
  ))
```

```{r}
result_str_Q7<- result_copy_Q7 %>%
  mutate(
    step_str = case_when(
      PSIVariableIdentifier %in% c(8035,8036,8037,8038,8039,8040,8041,8042,8043,8044,8045,8046) ~ information,
      eventname == "Nav:GoTo" & new_currentindex == 6 ~ "Begin_Q7",
      eventname == "Nav:GoTo" & new_currentindex != 6 ~ paste0("Navigate_to_Q", new_currentindex+1),
      eventname == "UI:Scrollbar" ~ sub('.*"event":"([^"]+).*"scrollTop":(\\d+).*', '\\1 \\2', information),
      eventname == "Btn:Calc" ~ paste0("Calculator_", gsub('.*To":"(\\w+).*', '\\1', information)),
      TRUE ~ NA_character_  # If none of the conditions are met, set to NA
    )
  )
result_str_Q7[c("RowNumber","step_str","information")]
```
 
If the row of value of the column eventname == "UI:Scrollbar", then the value of the row of the column step_str substitute the white space to _.
```{r}
result_str_use_Q7 <- result_str_Q7 %>%
  mutate(step_str = ifelse(eventname == "UI:Scrollbar", gsub(" ", "_", step_str), step_str))
result_str_use_Q7[c("RowNumber","step_str","information")]
```

```{r}
# Filter data and create a list to record all the steps needed.
df_filtered <- result_str_use_Q7 %>%
  filter(!is.na(step_str)) %>%
  group_by(idstud) %>%
  mutate(SQ02P07_allsteps_list = list(step_str[order(row_number())]))

# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02P07_allsteps_seq <- sapply(df_filtered$SQ02P07_allsteps_list, function(x) paste0("(", toString(x), ")"))
```

```{r}
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02P07_allsteps_seq")]

result_allsteps_Q7 <- merge(result_Final_choice_Q7, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)

result_allsteps_Q7=result_allsteps_Q7%>%
  group_by(idstud) %>%
  fill(SQ02P07_allsteps_seq, .direction = "downup")
# result_allsteps_Q7
```

```{r}
result_allsteps_Q7[c("idstud","SQ02P07_allsteps_seq","information")]
```


### Time Taken for All Steps
create a column to record the time taken for each single steps for each student to do this problem.
```{r}
# Filter data and create a list to record all the steps needed.
df_filtered <- result_str_use_Q7 %>%
  group_by(idstud) %>%
  mutate(SQ02P07_allsteps_list = list(SQ02P07_time[order(row_number())]))

# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02P07_allsteps_seq_time <- sapply(df_filtered$SQ02P07_allsteps_list, function(x) paste0("(", toString(x), ")"))

# filter the data and select column to merge
df_filtered <- select(df_filtered, -SQ02P07_allsteps_list)
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02P07_allsteps_seq_time")]

# merge the data
result_alls_time_Q7 <- merge(result_allsteps_Q7, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)

result_alls_time_Q7=result_alls_time_Q7%>%
  group_by(idstud) %>%
  fill(SQ02P07_allsteps_seq_time, .direction = "downup")
result_alls_time_Q7
```


### Unit Time for All Steps
create a column to record the time taken for each single steps for each student to do this problem.
```{r}
# Filter data and create a list to record all the steps needed.
df_filtered <- result_str_use_Q7 %>%
  group_by(idstud) %>%
  mutate(SQ02P07_allsteps_list = list(SQ02P07_unit_time[order(row_number())]))

# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02P07_allsteps_timestamp <- sapply(df_filtered$SQ02P07_allsteps_list, function(x) paste0("(", toString(x), ")"))

# filter the data and select column to merge
df_filtered <- select(df_filtered, -SQ02P07_allsteps_list)
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02P07_allsteps_timestamp")]

# merge the data
result_all_unit_time_Q7 <- merge(result_alls_time_Q7, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)

result_all_unit_time_Q7=result_all_unit_time_Q7%>%
  group_by(idstud) %>%
  fill(SQ02P07_allsteps_timestamp, .direction = "downup")

result_all_unit_time_Q7
```

### Total time taken
Create a new column SQ02P07_total_time. Group by idstud, SQ02P07_total_time = sum the value of the column SQ02P07_time for each idstud.

```{r}
# Group by idstud and calculate the sum of SQ02P07_time
result <- result_time_complete_Q7 %>%
  group_by(idstud) %>%
  summarise(SQ02P07_total_time = sum(SQ02P07_time, na.rm = TRUE))

# Merge the result back to the original data frame
result_total_time_Q7 <- merge(result_all_unit_time_Q7, result, by = "idstud", all.x = TRUE)

result_total_time_Q7
```

```{r}
result_total_time_Q7[c("idstud","SQ02P07_time","SQ02P07_total_time")]
```


### Save the data
Filter the columns of data frame, only keep the new created columns and idstud, idstud_ori, ImportLogID, BlockName, BookletPart, BlockInPart.
```{r}
resultP07 <- result_total_time_Q7 %>%
  select(idstud, idstud_ori, ImportLogID, BlockName, BookletPart,BlockInPart, module_path, SQ02P07_revise_sequence, SQ02P07_final_answer, SQ02P07_allsteps_seq, SQ02P07_allsteps_seq_time, SQ02P07_allsteps_timestamp, SQ02P07_total_time)
# resultP07
```


```{r}
resultP07_save = resultP07[!duplicated(resultP07), ]

condition1 <- resultP07_save$BlockName == 'SQ02' & 
              resultP07_save$BookletPart == 1 & 
              resultP07_save$BlockInPart == 1 

condition2 <- resultP07_save$BlockName == 'SQ02' & 
              resultP07_save$BookletPart == 2 & 
              resultP07_save$BlockInPart == 2

combined_condition <- condition1 | condition2

resultP07_save=resultP07_save%>%ungroup()%>% 
  filter(combined_condition)
resultP07_save
```

Save the dataframe
```{r}
# write_sav(resultP07_save, "../../../new_data/grade9/Pepper_Plants/SQ12P07_PSI.sav")

# write.csv(resultP07_save, file = 'csv_SQ12P07_PSI.csv', row.names = FALSE)
```

