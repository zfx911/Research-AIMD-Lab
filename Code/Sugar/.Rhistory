library(haven)
library(dplyr)
library(stringr)
library(tidyr)
library(jsonlite)
df_check <- read_sav("../../data/grade5/ASLNORZ7_processdata_PSIstudents.sav")
# Explore the data
head(df_check)
df <- read_sav("../../data/grade5/ASLNORZ7_processdata_PSIstudents.sav")
# Explore the data
head(df)
write.csv(df, file = 'grade5_PSI.csv', row.names = FALSE)
library(haven)
library(dplyr)
library(stringr)
library(tidyr)
library(jsonlite)
df <- read_sav("../../data/grade5/ASLNORZ7_processdata_PSIstudents.sav")
library(haven)
library(dplyr)
library(stringr)
library(tidyr)
library(jsonlite)
# Explore the data
head(df)
df_filter = df%>%
filter(df$PSIVariableIdentifier != 11126 |is.na(df$PSIVariableIdentifier))
condition1 <- df_filter$BlockName == 'SQ02' &
df_filter$BookletPart == 1 &
df_filter$BlockInPart == 1 &
df_filter$currentindex == 3
# Define the second condition
condition2 <- df_filter$BlockName == 'SQ02' &
df_filter$BookletPart == 2 &
df_filter$BlockInPart == 2 &
df_filter$currentindex == 17
# Combine the two conditions using OR (|) as you want rows satisfying either condition
combined_condition <- condition1 | condition2
# Use filter to get the rows that satisfy the conditions and one row below
result3 <- df_filter %>%
filter(combined_condition | lag(combined_condition, default = FALSE))
result3
result_use_Q3= transform(result3,
module_path = paste0("(", BlockName, ", ", BookletPart, ", ", BlockInPart, ")"))
head(result_use_Q3)
unique(result_use_Q3$eventname)
result_filter_Q3=result_use_Q3 %>%filter(eventname %in% c("Nav:GoTo", "Response", "UI:Scrollbar", "Btn:Ruler"))
result_filter_Q3
result_time_complete_Q3=result_filter_Q3 %>%
mutate(SQ02S03_time = ifelse(currentindex == 3 & eventname == 'Nav:GoTo' | currentindex == 17 & eventname == 'Nav:GoTo', 0, ifelse(timemilisec - lag(timemilisec) > 0,
(timeunixsec - lag(timeunixsec) + (timemilisec - lag(timemilisec))/1000),
(timeunixsec - lag(timeunixsec) - 1 + (timemilisec + 1000 - lag(timemilisec))/1000))))
# head(result_time_complete_Q3[c("idstud","module_path","SQ02S03_time")])
# result_time_complete_Q3
result_time_complete_Q3 = result_time_complete_Q3%>%
mutate(RowNumber = row_number())
result_time_complete_Q3$SQ02S03_unit_time <- result_time_complete_Q3$timeunixsec * 1000 + result_time_complete_Q3$timemilisec
# show all the units
result_time_complete_Q3$SQ02S03_unit_time <- format(result_time_complete_Q3$SQ02S03_unit_time, scientific = FALSE)
result_time_complete_Q3
# Filter data and arrange by idstud and information
df_filtered <- result_time_complete_Q3 %>%
filter(PSIVariableIdentifier == 11120)%>%
group_by(idstud) %>%
mutate(SQ02S03_sequence_list = list(information[order(row_number())]))
# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02S03_choice_sequence_TA <- sapply(df_filtered$SQ02S03_sequence_list, function(x) paste0("(", toString(x), ")"))
# df_filtered
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02S03_choice_sequence_TA")]
result_choice_seq_Q3_TA <- merge(result_time_complete_Q3, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
# result_choice_seq_Q3_TA
result_choice_seq_Q3_TA=result_choice_seq_Q3_TA%>%
group_by(idstud) %>%
fill(SQ02S03_choice_sequence_TA, .direction = "downup")
result_choice_seq_Q3_TA
# Filter the data based on PSIVariableIdentifier == 11120
filtered_data <- result_time_complete_Q3 %>% filter(PSIVariableIdentifier == 11120)%>%
filter(IsFinalAnswer == 1)
# Group by idstud and create the new column SQ02S02_final_choice
result <- filtered_data %>%
group_by(idstud) %>%
summarise(SQ02S02_final_choice_TA = information)
# Merge the result back to the original data frame
result_Final_choice_Q3_TA <- merge(result_choice_seq_Q3_TA, result, by = "idstud", all.x = TRUE)
result_Final_choice_Q3_TA
# Filter data and arrange by idstud and information
df_filtered <- result_time_complete_Q3 %>%
filter(PSIVariableIdentifier == 11121)%>%
group_by(idstud) %>%
mutate(SQ02S03_sequence_list = list(information[order(row_number())]))
# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02S03_choice_sequence_TB <- sapply(df_filtered$SQ02S03_sequence_list, function(x) paste0("(", toString(x), ")"))
# df_filtered
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02S03_choice_sequence_TB")]
result_choice_seq_Q3_TB <- merge(result_Final_choice_Q3_TB, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
result_choice_seq_Q3_TB <- merge(result_Final_choice_Q3_TA, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
# result_choice_seq_Q3_TB
result_choice_seq_Q3_TB=result_choice_seq_Q3_TB%>%
group_by(idstud) %>%
fill(SQ02S03_choice_sequence_TB, .direction = "downup")
result_choice_seq_Q3_TB
# Filter the data based on PSIVariableIdentifier == 11121
filtered_data <- result_time_complete_Q3 %>% filter(PSIVariableIdentifier == 11121)%>%
filter(IsFinalAnswer == 1)
# Group by idstud and create the new column SQ02S02_final_choice
result <- filtered_data %>%
group_by(idstud) %>%
summarise(SQ02S02_final_choice = information)
# Merge the result back to the original data frame
result_Final_choice_Q3_TB <- merge(result_choice_seq_Q3_TB, result, by = "idstud", all.x = TRUE)
result_Final_choice_Q3_TB
library(haven)
library(dplyr)
library(stringr)
library(tidyr)
library(jsonlite)
# Explore the data
head(df)
df_filter = df%>%
filter(eventname != "Btn:Next")
condition1 <- df_filter$BlockName == 'SQ02' &
df_filter$BookletPart == 1 &
df_filter$BlockInPart == 1
condition2 <- df_filter$BlockName == 'SQ02' &
df_filter$BookletPart == 2 &
df_filter$BlockInPart == 2
# Combine the two conditions using OR (|) as you want rows satisfying either condition
combined_condition <- condition1 | condition2
# Use filter to get the rows that satisfy the conditions and one row below
result_all <- df_filter %>%
filter(combined_condition | lag(combined_condition, default = FALSE))
result_all
result_all_use = result_all%>%
filter(row_number() == 1 |
currentindex != lag(currentindex) |
idstud != lag(idstud) |
eventname == "Nav:GoTo")
result_all_use
result_time_complete_all=result_all_use %>%
arrange(idstud, timeunixsec, timemilisec) %>%
group_by(idstud) %>%
mutate(
SQ02_time =ifelse(lead(timemilisec) - timemilisec > 0, (lead(timeunixsec)-timeunixsec + (lead(timemilisec)-timemilisec)/1000),(lead(timeunixsec)-timeunixsec - 1 + (lead(timemilisec)+1000 -timemilisec)/1000))
)
result_time_complete_all
result_time_complete_all[, c('idstud', 'SQ02_time', 'timeunixsec', 'timemilisec')]
result_time_complete_all = result_time_complete_all%>%
mutate(RowNumber = row_number())
result_time_complete_all$SQ02_all_unit_time <- result_time_complete_all$timeunixsec * 1000 + result_time_complete_all$timemilisec
# show all the units
result_time_complete_all$SQ02_all_unit_time <- format(result_time_complete_all$SQ02_all_unit_time, scientific = FALSE)
result_time_complete_all[, c('idstud', 'SQ02_time','currentindex' ,'SQ02_all_unit_time', 'timeunixsec', 'timemilisec')]
# result_time_complete_all
condition1 <- df_filter$BlockName == 'SQ02' &
df_filter$BookletPart == 1 &
df_filter$BlockInPart == 1
condition2 <- df_filter$BlockName == 'SQ02' &
df_filter$BookletPart == 2 &
df_filter$BlockInPart == 2
# Combine the two conditions using OR (|) as you want rows satisfying either condition
combined_condition <- condition1 | condition2
# Use filter to get the rows that satisfy the conditions and one row below
result_all <- df_filter %>%
filter(combined_condition | lag(combined_condition, default = FALSE))
result_all
result_all_use = result_all%>%
filter(row_number() == 1 |
currentindex != lag(currentindex) |
idstud != lag(idstud) |
eventname == "Nav:GoTo")
result_all_use
result_all_use = result_all%>%
filter(row_number() == 1 |
currentindex != lag(currentindex) |
idstud != lag(idstud) |
eventname == "Nav:GoTo")
result_all_use
result_all_use = result_all%>%
filter(row_number() == 1 |
currentindex != lag(currentindex) |
idstud != lag(idstud) |
eventname == "Nav:GoTo")
result_all_use
result_time_complete_all=result_all_use %>%
arrange(idstud, timeunixsec, timemilisec) %>%
group_by(idstud) %>%
mutate(
SQ02_time =ifelse(lead(timemilisec) - timemilisec > 0, (lead(timeunixsec)-timeunixsec + (lead(timemilisec)-timemilisec)/1000),(lead(timeunixsec)-timeunixsec - 1 + (lead(timemilisec)+1000 -timemilisec)/1000))
)
result_time_complete_all
result_time_complete_all[, c('idstud', 'SQ02_time', 'timeunixsec', 'timemilisec')]
result_time_complete_all = result_time_complete_all%>%
mutate(RowNumber = row_number())
result_time_complete_all$SQ02_all_unit_time <- result_time_complete_all$timeunixsec * 1000 + result_time_complete_all$timemilisec
# show all the units
result_time_complete_all$SQ02_all_unit_time <- format(result_time_complete_all$SQ02_all_unit_time, scientific = FALSE)
result_time_complete_all[, c('idstud', 'SQ02_time','currentindex' ,'SQ02_all_unit_time', 'timeunixsec', 'timemilisec')]
# result_time_complete_all
result_time_complete_all=result_time_complete_all%>%
filter(
(eventname == "Nav:GoTo" | eventname == "UI:IsLoaded") &
BlockName == "SQ02"
)
result_time_complete_all
result_copy_all=data.frame(result_time_complete_all)
result_copy_all <- result_copy_all %>%
mutate(new_currentindex = case_when(
currentindex == 14 ~ 0,
currentindex == 15 ~ 1,
currentindex == 16 ~ 2,
currentindex == 17 ~ 3,
currentindex == 18 ~ 4,
currentindex == 19 ~ 5,
currentindex == 20 ~ 6,
currentindex == 21 ~ 7,
currentindex == 22 ~ 8,
currentindex == 23 ~ 9,
currentindex == 24 ~ 10,
currentindex == 25 ~ 11,
TRUE ~ currentindex
))
cor_rule <- function(new_currentindex) {
result <- case_when(
new_currentindex == 1 ~ 1,
new_currentindex == 2 ~ 2,
new_currentindex == 3 ~ 3,
new_currentindex == 5 ~ 4,
new_currentindex == 6 ~ 5,
new_currentindex == 7 ~ 6,
new_currentindex == 8 ~ 7,
new_currentindex == 9 ~ 8,
new_currentindex == 10 ~ 9,
TRUE ~ NA_integer_
)
return(result)
}
result_copy_use <- result_copy_all %>%
mutate(new_index = case_when(
new_currentindex %in% c(1,2,3,5,7,9,10,11,12) ~ paste0("Page", new_currentindex+1, "_Q", cor_rule(new_currentindex),
TRUE ~ paste0("Page", new_currentindex+1, "_Q"))
))
df_filtered <- result_copy_use %>%
group_by(idstud) %>%
mutate(SQ02_Navigate_list = list(new_currentindex[order(row_number())]))
# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02_Navigate_seq <- sapply(df_filtered$SQ02_Navigate_list, function(x) paste0("(", toString(x), ")"))
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02_Navigate_seq")]
result_Navi_all <- merge(result_time_complete_all, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
result_Navi_all=result_Navi_all%>%
group_by(idstud) %>%
fill(SQ02_Navigate_seq, .direction = "downup")
result_Navi_all
df_filtered <- result_copy_use %>%
group_by(idstud) %>%
mutate(SQ02_Navigate_list = list(new_index[order(row_number())]))
# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02_Navigate_seq <- sapply(df_filtered$SQ02_Navigate_list, function(x) paste0("(", toString(x), ")"))
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02_Navigate_seq")]
result_Navi_all <- merge(result_time_complete_all, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
result_Navi_all=result_Navi_all%>%
group_by(idstud) %>%
fill(SQ02_Navigate_seq, .direction = "downup")
result_Navi_all
result_copy_use <- result_copy_all %>%
mutate(new_index = case_when(
new_currentindex %in% c(1,2,3,5,7,9,10,11,12) ~ paste0("Page", new_currentindex+1, "_Q", cor_rule(new_currentindex),
TRUE ~ paste0("Page", new_currentindex+1, "_Q"))
))
result_copy_use
result_copy_use <- result_copy_all %>%
mutate(new_index = case_when(
new_currentindex %in% c(1,2,3,5,7,9,10,11,12) ~ paste0("Page", new_currentindex+1, "_Q", cor_rule(new_currentindex),
!(new_currentindex %in% c(1,2,3,5,7,9,10,11,12)) ~ paste0("Page", new_currentindex+1, "_Q"))
))
result_copy_use
result_copy_all=data.frame(result_time_complete_all)
result_copy_all <- result_copy_all %>%
mutate(new_currentindex = case_when(
currentindex == 14 ~ 0,
currentindex == 15 ~ 1,
currentindex == 16 ~ 2,
currentindex == 17 ~ 3,
currentindex == 18 ~ 4,
currentindex == 19 ~ 5,
currentindex == 20 ~ 6,
currentindex == 21 ~ 7,
currentindex == 22 ~ 8,
currentindex == 23 ~ 9,
currentindex == 24 ~ 10,
currentindex == 25 ~ 11,
TRUE ~ currentindex
))
cor_rule <- function(new_currentindex) {
result <- case_when(
new_currentindex == 1 ~ 1,
new_currentindex == 2 ~ 2,
new_currentindex == 3 ~ 3,
new_currentindex == 5 ~ 4,
new_currentindex == 6 ~ 5,
new_currentindex == 7 ~ 6,
new_currentindex == 8 ~ 7,
new_currentindex == 9 ~ 8,
new_currentindex == 10 ~ 9,
TRUE ~ NA_integer_
)
return(result)
}
result_copy_use <- result_copy_all %>%
mutate(new_index = case_when(
new_currentindex %in% c(1,2,3,5,7,9,10,11,12) ~ paste0("Page", new_currentindex+1, "_Q", cor_rule(new_currentindex)),
TRUE ~ paste0("Page", new_currentindex+1)
))
result_copy_use
result_copy_use <- result_copy_all %>%
mutate(new_index = case_when(
new_currentindex %in% c(1,2,3,5,7,9,10,11,12) ~ paste0("Page", new_currentindex+1, "_Q", cor_rule(new_currentindex)),
TRUE ~ paste0("Page", new_currentindex+1)
))
result_copy_use
df_filtered <- result_copy_use %>%
group_by(idstud) %>%
mutate(SQ02_Navigate_list = list(new_index[order(row_number())]))
# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02_Navigate_seq <- sapply(df_filtered$SQ02_Navigate_list, function(x) paste0("(", toString(x), ")"))
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02_Navigate_seq")]
result_Navi_all <- merge(result_time_complete_all, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
result_Navi_all=result_Navi_all%>%
group_by(idstud) %>%
fill(SQ02_Navigate_seq, .direction = "downup")
result_Navi_all
# Filter data and create a list to record all the steps needed.
df_filtered <- result_copy_all %>%
group_by(idstud) %>%
mutate(SQ02_Navigate_list = list(SQ02_time[order(row_number())]))
# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02_Navigate_seq_time <- sapply(df_filtered$SQ02_Navigate_list, function(x) paste0("(", toString(x), ")"))
# filter the data and select column to merge
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02_Navigate_seq_time")]
# merge the data
result_alls_time_all <- merge(result_Navi_all, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
result_alls_time_all=result_alls_time_all%>%
group_by(idstud) %>%
fill(SQ02_Navigate_seq_time, .direction = "downup")
result_alls_time_all
# Filter data and create a list to record all the steps needed.
df_filtered <- result_copy_all %>%
group_by(idstud) %>%
mutate(SQ02_Navigate_list = list(SQ02_all_unit_time[order(row_number())]))
# Convert the list column to a new column with the desired format, and then drop the list column
df_filtered$SQ02_Navigate_timestamp <- sapply(df_filtered$SQ02_Navigate_list, function(x) paste0("(", toString(x), ")"))
# filter the data and select column to merge
df_filtered <- select(df_filtered, -SQ02_Navigate_list)
df_filtered_merge = df_filtered[c("idstud","RowNumber","SQ02_Navigate_timestamp")]
# merge the data
result_all_unit_time_all <- merge(result_alls_time_all, df_filtered_merge, by = c("idstud","RowNumber"), all = TRUE)
result_all_unit_time_all=result_all_unit_time_all%>%
group_by(idstud) %>%
fill(SQ02_Navigate_timestamp, .direction = "downup")
result_all_unit_time_all
# Group by idstud and calculate the sum of SQ02_time
result <- result_copy_all %>%
group_by(idstud) %>%
summarise(SQ02_unit_total_time = sum(SQ02_time, na.rm = TRUE))
# Merge the result back to the original data frame
result_total_time_all <- merge(result_all_unit_time_all, result, by = "idstud", all.x = TRUE)
result_total_time_all
# result_total_time_all[c("idstud","SQ02_time","SQ02_unit_total_time")]
resultAll <- result_total_time_all %>%
select(idstud, idstud_ori, ImportLogID, BlockName, BookletPart,BlockInPart, SQ02_Navigate_seq, SQ02_Navigate_seq_time, SQ02_Navigate_timestamp, SQ02_unit_total_time)
# resultAll
resultAll_save = resultAll[!duplicated(resultAll), ]
condition1 <- resultAll_save$BlockName == 'SQ02' &
resultAll_save$BookletPart == 1 &
resultAll_save$BlockInPart == 1
condition2 <- resultAll_save$BlockName == 'SQ02' &
resultAll_save$BookletPart == 2 &
resultAll_save$BlockInPart == 2
combined_condition <- condition1 | condition2
resultAll_save=resultAll_save%>%ungroup()%>%
filter(combined_condition)
resultAll_save
library(haven)
library(dplyr)
library(stringr)
library(tidyr)
library(jsonlite)
write_sav(resultAll_save, "../../../new_data/grade5/Farm/SQ02Sall_PSI.sav")
# write.csv(resultAll_save, file = 'csv_SQ02Sall_PSI.csv', row.names = FALSE)
library(haven)
library(dplyr)
library(stringr)
library(tidyr)
library(jsonlite)
write_sav(resultAll_save, "../../../new_data/grade5/Sugar/SQ02Sall_PSI.sav")
# write.csv(resultAll_save, file = 'csv_SQ02Sall_PSI.csv', row.names = FALSE)
